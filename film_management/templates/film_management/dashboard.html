<!DOCTYPE HTML>
<html>
    <head>
        {% load static %}
        <meta name="viewport" content="width=device-width, initial-scale=1">
        {% if is_filmweek %}
            <link rel="stylesheet" type="text/css" href="{% static 'dashboard/css/style_voting.css' %}">
        {% else %}
            <link rel="stylesheet" type="text/css" href="{% static 'dashboard/css/style_submissions.css' %}">
        {% endif %}
        <link href="//fonts.googleapis.com/css?family=Roboto+Slab|Inconsolata:400,700" rel="stylesheet" type="text/css">
    </head>
    <body>
        <div id="content">
            {% if is_filmweek %}
                <h1>Voting is open</h1>
                    <div id="films">
                        {% for film in shortlisted_films %}
                            <div class="film" onclick="updateFilm(this)" data-identifier="{{ film.film_id }}">
                                <p>{{ film.name }}</p>
                                <img class="film-image" src="{% if film.poster_path != '' %}https://image.tmdb.org/t/p/w200{{ film.poster_path }}{% else %}/static/images/placeholder_film.png{% endif %}">
                            </div>
                        {% endfor %}
                    </div>
                    <script>
                    var checkedFilms = {{ current_votes|safe }}

                    function updateFilm (element) {
                        var filmBackground = element.style.backgroundColor

                        if (filmBackground === '') {
                            element.style.backgroundColor = '#e8dafa'
                            checkedFilms.push(element.getAttribute("data-identifier"))
                        } else {
                            element.style.backgroundColor = ''
                            checkedFilms.splice(checkedFilms.indexOf(element.getAttribute("data-identifier")))
                        }
                        var voteRequest = new XMLHttpRequest()
                        voteRequest.open('POST', '/film_management/submit_votes/')
                        voteRequest.setRequestHeader('X-CSRFToken', '{{ csrf_token }}')
                        voteRequest.send(JSON.stringify(checkedFilms))
                    }

                    for (var i=0; i<checkedFilms.length; i++) {
                        var element = document.querySelector('[data-identifier='+checkedFilms[i]+']')
                        element.style.backgroundColor = '#e8dafa'
                    }
                    </script>
                    <a id="films-link" href="/films/">See all submitted films</a>
            {% else %}
                <h1>Submissions are open</h1>
                <form method="POST" action="/film_management/submit_film/" id="submit-form">
                    {% csrf_token %}
                    <input type="text" id="film-input" name="film_name" autocomplete="off">
                    <input type="submit" id="film-submit">
                </form>
                <p id="response-message" style="opacity: 0">.</p>
                <script>
                var timeRemaining = 0
                document.addEventListener('submit', function (e) {
                    e.preventDefault()
                    const form = e.target

                    fetch(form.action, {
                        method: form.method,
                        body: new FormData(form)
                    }).then(function (response) {
                        response.json().then(function (data) {
                            var responseMessage = document.getElementById('response-message')
                            if (!data['success']) {
                                if (data['error'] === 1) {
                                    responseMessage.innerHTML = 'Film already submitted'
                                    setTimeout(function () {
                                        responseMessage.style.opacity = '0'
                                    }, 1500)
                                } else if (data['error'] === 2) {
                                    timeRemaining = data['time']
                                    responseMessage.innerHTML = 'You are doing that too fast. Try again in ' + timeRemaining + ' seconds'
                                    var timeDecrementInterval = setInterval(function () {
                                        timeRemaining -= 1
                                        if (timeRemaining < 0) {
                                            responseMessage.style.opacity = '0'
                                            clearInterval(timeDecrementInterval)
                                        } else {
                                            responseMessage.innerHTML = 'You are doing that too fast. Try again in ' + timeRemaining + ' seconds'   
                                        }
                                    }, 1000)
                                }
                                responseMessage.style.opacity = '1'
                            } else {
                                responseMessage.innerHTML = 'Successfully added film'
                                responseMessage.style.opacity = '1'
                                setTimeout(function () {
                                   responseMessage.style.opacity = '0'
                                }, 1500)
                            }
                        })
                    })
                })
                </script>
                <a id="films-link" href="/films/">See all submitted films</a>
            {% endif %}
        </div>
    </body>
</html>
